{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EventEase</title>

  <link rel="stylesheet" href="{% static 'css/style.css' %}" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>
  <nav>
    <div class="nav-container">
      <div class="logo">
        <a href="{% url 'home' %}">EventEase</a>
      </div>
      <ul class="nav-links">
        {% if user.is_authenticated %}
          <li><a href="{% url 'home' %}">Home</a></li>
          <li><a href="{% url 'create_event' %}">Add Event</a></li>
          <li><a href="{% url 'my_joined_events' %}">My Events</a></li>
          <li><a href="{% url 'profile' %}">Profile</a></li>

          <!-- Notifications Dropdown -->
          <li class="nav-item dropdown">
            <a class="nav-link position-relative" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-bell"></i>
              {% if unread_count > 0 %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                {{ unread_count }}
              </span>
              {% endif %}
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown">
              {% if unread_notifications %}
                {% for note in unread_notifications %}
                <li>
                  <a class="dropdown-item small" href="{% url 'mark_notification_read' note.id %}">
                    {{ note.message }}<br />
                    <small class="text-muted">{{ note.created_at|timesince }} ago</small>
                  </a>
                </li>
                {% endfor %}
              {% else %}
                <li><span class="dropdown-item-text text-muted">No new notifications</span></li>
              {% endif %}
              <li><hr class="dropdown-divider" /></li>
              <li><a class="dropdown-item text-center" href="{% url 'all_notifications' %}">View all</a></li>
            </ul>
          </li>

          <!-- Dark Mode Toggle -->
          <button id="darkModeToggle" class="toggle-btn" title="Toggle Dark Mode">
            <i class="bi bi-moon-fill"></i>
          </button>

          <li>
            <form action="{% url 'logout' %}" method="post" class="logout-form">
              {% csrf_token %}
              <button type="submit" class="logout-btn">Logout</button>
            </form>
          </li>
          <li class="welcome">Hi, {{ user.username }}</li>
        {% else %}
          <li><a href="{% url 'login' %}">Login</a></li>
          <li><a href="{% url 'signup' %}">Register</a></li>
        {% endif %}
      </ul>
    </div>
  </nav>

  <main class="container py-4">
    {% block content %}{% endblock %}
  </main>

  <footer class="text-center mt-4 mb-2 text-muted">
    <p>&copy; 2025 EventEase | All rights reserved.</p>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Flatpickr Init -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const inputs = document.querySelectorAll("input[type='datetime-local']");
      inputs.forEach(input => {
        let defaultDate = null;
        if (input.value) {
          const utcDate = new Date(input.value.replace(" ", "T"));
          const localDate = new Date(utcDate.getTime() - utcDate.getTimezoneOffset() * 60000);
          defaultDate = localDate;
        }
        flatpickr(input, {
          enableTime: true,
          dateFormat: "Y-m-d H:i",
          minDate: "today",
          time_24hr: true,
          defaultDate: defaultDate || null,
        });
      });
    });
  </script>

  <!-- Notifications Auto-Update -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const bell = document.querySelector("#notificationDropdown");
      let badge = bell?.querySelector(".badge");
      const dropdown = bell?.nextElementSibling;

      async function fetchNotifications() {
        try {
          const res = await fetch("{% url 'check_new_notifications' %}");
          if (!res.ok) return;
          const data = await res.json();

          if (data.count > 0) {
            if (!badge) {
              badge = document.createElement("span");
              badge.className = "position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger fade-in";
              badge.textContent = data.count;
              bell.appendChild(badge);
            } else {
              badge.textContent = data.count;
              badge.style.display = "inline-block";
              badge.classList.add("fade-in");
              setTimeout(() => badge.classList.remove("fade-in"), 800);
            }
          } else if (badge) {
            badge.style.display = "none";
          }

          if (dropdown) {
            const existingItems = dropdown.querySelectorAll("li:not(:last-child)");
            existingItems.forEach(li => li.remove());

            if (data.notifications.length > 0) {
              data.notifications.forEach(note => {
                const li = document.createElement("li");
                li.classList.add("fade-in");
                li.innerHTML = `
                  <a class="dropdown-item small" href="/notifications/read/${note.id}/">
                    ${note.message}<br>
                    <small class="text-muted">${note.created_at}</small>
                  </a>`;
                dropdown.insertBefore(li, dropdown.lastElementChild);
              });
            } else {
              const li = document.createElement("li");
              li.innerHTML = `<span class="dropdown-item-text text-muted">No new notifications</span>`;
              dropdown.insertBefore(li, dropdown.lastElementChild);
            }
          }
        } catch (err) {
          console.error("Notification fetch error:", err);
        }
      }

      setInterval(fetchNotifications, 30000);
    });
  </script>
  
  <script>
  (function () {
    const toggle = document.getElementById('darkModeToggle');
    const body = document.body;
    const STORAGE_KEY = 'darkMode';

    // helper to set icon
    function setIcon(enabled) {
      if (!toggle) return;
      toggle.innerHTML = enabled ? '<i class="bi bi-sun-fill"></i>' : '<i class="bi bi-moon-fill"></i>';
    }

    // apply saved preference
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved === 'enabled') {
        body.classList.add('dark-mode');
        setIcon(true);
      } else if (saved === 'disabled') {
        body.classList.remove('dark-mode');
        setIcon(false);
      } else {
        // no saved preference -> follow system preference
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) {
          body.classList.add('dark-mode');
          setIcon(true);
        } else {
          setIcon(false);
        }
      }
    } catch (e) {
      // localStorage may throw in some environments; ignore gracefully
      setIcon(false);
    }

    // safe click handler if toggle exists
    if (toggle) {
      toggle.addEventListener('click', () => {
        const enabled = body.classList.toggle('dark-mode');
        setIcon(enabled);
        try {
          localStorage.setItem(STORAGE_KEY, enabled ? 'enabled' : 'disabled');
        } catch (e) {
          // ignore
        }
      });
    }
  })();
</script>

</body>
</html>
