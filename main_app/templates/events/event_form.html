{% extends 'base.html' %}
{% block content %}

<div class="container mt-4" style="max-width: 700px;">
    <h2 class="text-center mb-4">{% if form.instance.pk %}Edit Event{% else %}Create New Event{% endif %}</h2>

    <form method="post">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="mb-3">
            <label for="{{ form.title.id_for_label }}" class="form-label">Title</label>
            {{ form.title }}
        </div>

        <div class="mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
            {{ form.description }}
        </div>

        <div class="mb-3">
            <label for="{{ form.event_date.id_for_label }}" class="form-label">Event Date</label>
            {{ form.event_date }}
        </div>

        <div class="mb-3">
            <label for="{{ form.location.id_for_label }}" class="form-label">Location</label>
            {{ form.location }}
            <small class="form-text text-muted">Click on the map below to select a location.</small>
        </div>

        <div id="map" style="height: 400px; border-radius: 10px; margin-bottom: 20px;"></div>

        <div class="mb-3">
            <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
            {{ form.category }}
        </div>

        <button type="submit" class="btn btn-primary w-100">Save Event</button>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const defaultLatLng = [31.963158, 35.930359];

    const map = L.map('map').setView(defaultLatLng, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker = null;

    const locationInput = document.getElementById("id_location");
    if (locationInput.value) {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationInput.value)}`)
            .then(res => res.json())
            .then(data => {
                if (data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    map.setView([lat, lon], 14);
                    marker = L.marker([lat, lon]).addTo(map);
                }
            });
    }

    map.on('click', async (e) => {
        const { lat, lng } = e.latlng;

        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng]).addTo(map);
        }

        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
            const data = await response.json();
            if (data && data.display_name) {
                locationInput.value = data.display_name;
            } else {
                locationInput.value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
            }
        } catch {
            locationInput.value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        }
    });
});

document.querySelector("form").addEventListener("submit", function() {
    const dateInput = document.getElementById("id_event_date");
    if (dateInput && dateInput.value.includes(" ")) {
        dateInput.value = dateInput.value.replace(" ", "T");
    }
});

</script>

{% endblock %}
